<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTHz Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap');

        .font-noto {
            font-family: 'Noto Sans', sans-serif;
        }

        .font-roboto {
            font-family: 'Roboto', sans-serif;
        }

        .btn-primary {
            background: #4d8ef9;
            box-shadow: 0px 4px 9px -4px #3b71ca;
        }

        .card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>

<body class="bg-[#f9fafe] min-h-screen font-noto">
    <!-- Logo -->
    <div class="absolute h-[52px] left-[36px] top-[36px] w-[193px]">
        <img alt="CTHz Logo" class="w-full h-full object-cover" src="{{ url_for('static', path='assests/images/logoblack.png') }}" />
    </div>
   
    <!-- Main Content -->
    <div class="min-h-screen grid grid-cols-1 lg:grid-cols-2 gap-0 my-12">
        <!-- Left Visual Panel -->
        <div class="relative hidden lg:block">
            <!-- Background Image / Visual -->
            <div class="absolute inset-0 flex items-center justify-center rounded-[8px]" >
                <div class="w-[500px] h-[500px] max-h-[70vh] overflow-hidden rounded-[8px] relative">
                    <img
                        src="{{ url_for('static', path='assests/images/loginpage.png') }}"
                        alt="CTHz Visual"
                        class="w-full h-full object-cover"
                    />
                    <div class="absolute left-[1.5rem] bottom-[2rem] max-w-[400px] text-white">
                        <div class="text-[26px] leading-8">
                            A new era in enterprise weapons detection from the pioneers in
                        </div>
                        <div class="text-[24px] underline font-semibold">
                            TeraHertz Imaging
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right form panel -->
        <div class="flex items-center justify-center p-6">
            <div class="w-full max-w-[437px]">
                <div class="mb-10">
                    <h1 class="text-[32px] font-medium text-black">CtHZ Management System</h1>
                    <p class="text-[14px] text-[#717182]">Get access to Cambridge THz device management</p>
                </div>

                <div class="mb-8">
                    <h2 class="text-[18px] font-semibold text-black">Login to your account</h2>
                    <p class="text-[12px] text-[#9c9ca9]">Login using username and password created during System Setup
                    </p>
                </div>

                <form id="login-form" class="space-y-5">
                    <div>
                        <label for="username" class="block text-[14px] font-medium text-black mb-1">Username</label>
                        <input id="username" name="username" type="text" required
                            class="w-full text-[14px] bg-[#f5f8fc] border border-[#dfe0e2] rounded-[3px] px-3 py-3 outline-none"
                            placeholder="Owner" />
                    </div>
                    <div>
                        <label for="password" class="block text-[14px] font-medium text-black mb-1">Password</label>
                        <div class="relative">
                            <input id="password" name="password" type="password" required maxlength="72"
                                class="w-full text-[14px] bg-[#f5f8fc] border border-[#dfe0e2] rounded-[3px] px-3 py-3 pr-10 outline-none"
                                placeholder="Enter Secure Password" />
                            <button type="button" aria-label="Toggle password" class="absolute inset-y-0 right-2 flex items-center text-[#8c99a9]" onclick="togglePassword('password', 'pwd-eye')">
                                <svg id="pwd-eye" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 3C5 3 1.73 7.11.46 10c1.27 2.89 4.54 7 9.54 7s8.27-4.11 9.54-7C18.27 7.11 15 3 10 3zm0 12a5 5 0 110-10 5 5 0 010 10z"></path>
                                    <circle cx="10" cy="10" r="3"></circle>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div id="result" class="mt-2"></div>

                    <button type="button" id="login-btn" onclick="submitLogin()"
                        class="btn-primary w-full text-white rounded-[4px] font-roboto font-medium uppercase text-[12px] py-3">Login</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        function showError(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="text-red-500 text-sm">${message}</div>`;
        }

        function showSuccess(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="text-green-500 text-sm">${message}</div>`;
        }

        function clearMessage() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';
        }

        function togglePassword(inputId, eyeId) {
            const input = document.getElementById(inputId);
            const eye = document.getElementById(eyeId);
            const showing = input.type === 'text';
            input.type = showing ? 'password' : 'text';
            // swap icon (simple toggle between eye and eye-off styles)
            eye.innerHTML = showing
                ? '<path d="M10 3C5 3 1.73 7.11.46 10c1.27 2.89 4.54 7 9.54 7s8.27-4.11 9.54-7C18.27 7.11 15 3 10 3zm0 12a5 5 0 110-10 5 5 0 010 10z"></path><circle cx="10" cy="10" r="3"></circle>'
                : '<path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"></path><path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"></path>';
        }

        async function submitLogin() {
            clearMessage();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('login-btn');

            if (!username || !password) {
                showError('Please enter both username and password');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    showSuccess('Login successful! Redirecting...');
                    
                    // Store token in localStorage for API calls
                    localStorage.setItem('access_token', data.access_token);
                    localStorage.setItem('user_role', data.role);
                    localStorage.setItem('user_name', username); // Store username for immediate display
                    
                    // Set cookie for web page authentication (Safari compatible)
                    const cookieValue = `access_token=${data.access_token}; path=/; max-age=${data.expires_in_hours * 3600}; samesite=lax`;
                    document.cookie = cookieValue;
                    
                    console.log('DEBUG: Cookie set:', cookieValue);
                    console.log('DEBUG: All cookies:', document.cookie);
                    
                    // Check if we're on Safari or if cookies aren't working
                    setTimeout(() => {
                        // For Safari compatibility, redirect with token as query parameter
                        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                        if (isSafari || document.cookie.indexOf('access_token=') === -1) {
                            console.log('DEBUG: Safari detected or cookies not working, using query parameter');
                            window.location.href = `/dashboard?token=${data.access_token}`;
                        } else {
                            window.location.href = '/dashboard';
                        }
                    }, 1000);
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Login failed');
                }
            } catch (error) {
                showError('Login failed: ' + error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login';
            }
        }

        // Allow Enter key to submit form
        document.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                submitLogin();
            }
        });
    </script>
</body>
</html>