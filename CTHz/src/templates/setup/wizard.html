<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTHz System Setup</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap');
        
        .font-noto { font-family: 'Noto Sans', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        
        .stepper-icon {
            background: #e3ebf7;
            border: 1px solid #3b71ca;
            border-radius: 21px;
            color: #285192;
        }
        
        .stepper-icon-inactive {
            background: #ebedef;
            border-radius: 21px;
            color: #40464f;
        }
        
        .stepper-icon-completed {
            background: #d6f0e0;
            border-radius: 21px;
            color: #0d6832;
        }
        
        .stepper-text-active {
            color: #3b71ca;
        }
        
        .stepper-text-inactive {
            color: #757575;
        }
        
        .divider-line {
            height: 1px;
            background: #ededed;
        }
        
        .form-input {
            background: #f5f8fc;
            border: 1px solid #dfe0e2;
            border-radius: 3px;
        }
        
        .btn-primary {
            background: #4d8ef9;
            box-shadow: 0px 4px 9px -4px #3b71ca;
        }
        
        .btn-secondary {
            background: #e3ebf7;
            color: #285192;
            opacity: 0.5;
        }
        
        .btn-outline {
            border: 2px solid #e3ebf7;
            background: transparent;
            color: #285192;
        }
        
        .toggle-switch {
            width: 32px;
            height: 18px;
            background: #e3ebf7;
            border-radius: 9px;
            position: relative;
            cursor: pointer;
        }
        
        .toggle-switch.active {
            background: #4d8ef9;
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.3s;
        }
        
        .toggle-switch.active::after {
            left: 16px;
        }
        
        .hidden { display: none; }
        .error { color: #dc2626; margin-top: 5px; }
        
        .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .setup-card {
            width: 737px;
            max-width: 100%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-[#f9fafe] min-h-screen">
    <div class="main-container">
        <!-- Header Logo -->
        <div class="absolute h-[52px] left-[36px] top-[36px] w-[193px]">
            <img alt="CTHz Logo" class="w-full h-full object-cover" src="/static/assests/images/logoblack.png" />
            </div>
            
        <!-- Main Setup Card -->
        <div class="setup-card">
            <div class="content-stretch flex flex-col gap-[43px] items-center relative shrink-0 w-full p-6">
                <!-- Header -->
                <div class="content-stretch flex flex-col gap-[8px] items-center leading-[normal] relative shrink-0 text-black w-full whitespace-pre-wrap">
                    <p class="font-noto font-medium relative shrink-0 text-[28px] text-center w-full">System Setup</p>
                    <p class="font-noto font-normal relative shrink-0 text-[14px] text-center w-full">Configure your CT3D Management System</p>
                </div>
                
                <!-- Progress Steps -->
                <div class="border-[#ededed] border-b border-l-0 border-r-0 border-solid border-t-0 box-border content-stretch flex items-start relative shrink-0 w-full">
                    <div class="content-stretch flex flex-[1_0_0] items-start min-h-px min-w-px relative shrink-0">
                        <div class="box-border content-stretch flex flex-[1_0_0] items-center min-h-px min-w-px pl-[24px] pr-0 py-0 relative shrink-0">
                            <div class="box-border content-stretch flex gap-[10px] items-start pl-0 pr-[8px] py-[24px] relative shrink-0">
                                <div id="step-icon-1" class="stepper-icon box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]">
                                    <p class="font-roboto font-medium leading-[1.3] relative shrink-0 text-[14px]">1</p>
                                </div>
                            </div>
                            <p id="step-text-1" class="font-roboto font-medium leading-[1.3] relative shrink-0 text-[13px] stepper-text-active">Setup Mode</p>
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                        </div>
                    </div>
                    <div class="content-stretch flex flex-[1_0_0] items-start min-h-px min-w-px relative shrink-0">
                        <div class="content-stretch flex flex-[1_0_0] items-center min-h-px min-w-px relative shrink-0">
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                            <div class="box-border content-stretch flex gap-[10px] items-start px-[8px] py-[24px] relative shrink-0">
                                <div id="step-icon-2" class="stepper-icon-inactive box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]">
                                    <p class="font-roboto font-medium leading-[1.3] relative shrink-0 text-[14px]">2</p>
                                </div>
                            </div>
                            <p id="step-text-2" class="font-roboto font-normal leading-[1.3] relative shrink-0 text-[13px] stepper-text-inactive">Network</p>
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                        </div>
                    </div>
                    <div class="content-stretch flex flex-[1_0_0] items-start min-h-px min-w-px relative shrink-0">
                        <div class="content-stretch flex flex-[1_0_0] items-center min-h-px min-w-px relative shrink-0">
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                            <div class="box-border content-stretch flex gap-[10px] items-start px-[8px] py-[24px] relative shrink-0">
                                <div id="step-icon-3" class="stepper-icon-inactive box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]">
                                    <p class="font-roboto font-medium leading-[1.3] relative shrink-0 text-[14px]">3</p>
                                </div>
                            </div>
                            <p id="step-text-3" class="font-roboto font-normal leading-[1.3] relative shrink-0 text-[13px] stepper-text-inactive">Account</p>
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                        </div>
                    </div>
                    <div class="content-stretch flex flex-[1_0_0] items-start min-h-px min-w-px relative shrink-0">
                        <div class="box-border content-stretch flex flex-[1_0_0] items-center min-h-px min-w-px pl-0 pr-[24px] py-0 relative shrink-0">
                            <div class="flex-[1_0_0] h-0 min-h-px min-w-px relative shrink-0">
                                <div class="absolute bottom-0 left-0 right-0 top-[-0.5px] divider-line"></div>
                            </div>
                            <div class="box-border content-stretch flex gap-[10px] items-start px-[8px] py-[24px] relative shrink-0">
                                <div id="step-icon-4" class="stepper-icon-inactive box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]">
                                    <p class="font-roboto font-medium leading-[1.3] relative shrink-0 text-[14px]">4</p>
                                </div>
                            </div>
                            <p id="step-text-4" class="font-roboto font-normal leading-[1.3] relative shrink-0 text-[13px] stepper-text-inactive">Device</p>
                        </div>
                    </div>
                </div>

                <!-- Step Content -->
                <div class="content-stretch flex flex-col gap-[32px] items-start relative shrink-0 w-full">
                    <!-- Step 1: Setup Mode Selection -->
                    <div id="step-1" class="step content-stretch flex flex-col gap-[32px] items-start relative shrink-0 w-full">
                        <div class="content-stretch flex flex-col gap-[5px] items-start leading-[normal] relative shrink-0 w-[278px] whitespace-pre-wrap">
                            <p class="font-noto font-semibold relative shrink-0 text-[18px] text-black w-full">Setup Mode</p>
                            <p class="font-noto font-normal relative shrink-0 text-[#8e8e9d] text-[12px] w-full">Choose how you want to setup this CT3D device</p>
                        </div>
                        
                        <div class="content-stretch flex gap-[21px] items-center relative shrink-0 w-full">
                            <!-- New Installation Card -->
                            <div class="bg-[#f9fafe] box-border content-stretch flex flex-col gap-[10px] h-[192px] items-center justify-center px-[56px] py-[14px] relative rounded-[4px] shrink-0 w-[325px] cursor-pointer hover:bg-[#f0f4ff] transition-colors" onclick="selectSetupMode('new')">
                                <div class="content-stretch flex flex-col gap-[11px] items-center relative shrink-0 w-[213px]">
                                    <div class="grid-cols-[max-content] grid-rows-[max-content] inline-grid justify-items-start leading-[0] relative shrink-0">
                                        <div class="col-[1] ml-0 mt-[9px] relative row-[1] size-[50px]">
                                            <svg class="w-[50px] h-[50px] text-[#4d8ef9]" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                        </div>
                                        <div class="col-[1] ml-[28px] mt-0 relative row-[1] size-[29px]">
                                            <svg class="w-[29px] h-[29px] text-[#4d8ef9]" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                            </svg>
                                        </div>
                                    </div>
                                    <div class="content-stretch flex flex-col gap-[8px] items-center leading-[normal] relative shrink-0 text-center w-full whitespace-pre-wrap">
                                        <p class="font-noto font-medium relative shrink-0 text-[16px] text-black w-full">New Installation</p>
                                        <p class="font-noto font-normal relative shrink-0 text-[#717182] text-[12px] w-full">Setup as the primary device with admin account</p>
                                    </div>
                                </div>
                                <input type="radio" name="setup-mode" value="new" class="absolute opacity-0" checked>
                    </div>
                    
                            <!-- Join Existing Network Card -->
                            <div class="bg-[#f9fafe] box-border content-stretch flex flex-col gap-[10px] h-[192px] items-center justify-center px-[63px] py-[23px] relative rounded-[4px] shrink-0 w-[325px] cursor-pointer hover:bg-[#f0f4ff] transition-colors" onclick="selectSetupMode('join')">
                                <div class="content-stretch flex flex-col gap-[11px] items-center relative shrink-0 w-[198px]">
                                    <div class="relative shrink-0 size-[50px]">
                                        <svg class="w-[50px] h-[50px] text-[#4d8ef9]" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                                        </svg>
                                    </div>
                                    <div class="content-stretch flex flex-col gap-[8px] items-center leading-[normal] relative shrink-0 text-center w-full whitespace-pre-wrap">
                                        <p class="font-noto font-medium relative shrink-0 text-[16px] text-black w-full">Join Existing Network</p>
                                        <p class="font-noto font-normal relative shrink-0 text-[#717182] text-[12px] w-full">Connect to an already configured CT3D network</p>
                                    </div>
                                </div>
                                <input type="radio" name="setup-mode" value="join" class="absolute opacity-0">
                            </div>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[4px] items-start leading-[normal] relative shrink-0 text-[12px] w-full whitespace-pre-wrap">
                            <p class="font-noto font-medium relative shrink-0 text-[#606070] w-full">Note:</p>
                            <p class="font-noto font-normal relative shrink-0 text-[#8e8e9d] w-full">Select "New Installation" if this is your first CT3D device, or "Join Existing Network" if you're adding this device to an already configured system.</p>
                        </div>
                        
                        <div id="error-1" class="error hidden"></div>
                        
                        <div class="content-stretch flex gap-[12px] items-center justify-end relative shrink-0 w-full">
                            <button id="next-btn-1" onclick="proceedToNextStep()" class="btn-primary content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 text-white font-noto font-medium text-[14px]">
                                Continue
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Network Configuration -->
                    <div id="step-2" class="step hidden content-stretch flex flex-col gap-[32px] items-start relative shrink-0 w-full">
                        <div class="content-stretch flex flex-col gap-[4px] items-start leading-[normal] relative shrink-0 w-[278px] whitespace-pre-wrap">
                            <p class="font-noto font-semibold relative shrink-0 text-[18px] text-black w-full">Network Configuration</p>
                            <p class="font-noto font-normal relative shrink-0 text-[#8e8e9d] text-[12px] w-full">Configure network settings for your CT3D system</p>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Network Configuration</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <select id="network-mode" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                                    <option value="dhcp">DHCP (Automatic)</option>
                                    <option value="static">Static IP</option>
                                </select>
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- WiFi Enable/Disable Toggle -->
                        <div class="content-stretch flex items-center justify-between relative shrink-0 w-full">
                            <div class="content-stretch flex flex-col gap-[4px] items-start relative shrink-0">
                                <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black whitespace-pre-wrap">Enable WiFi</p>
                                <p class="font-noto font-normal leading-[normal] relative shrink-0 text-[12px] text-[#8e8e9d] whitespace-pre-wrap">Connect to a wireless network</p>
                            </div>
                            <div class="toggle-switch" id="wifi-toggle" onclick="toggleWiFi()">
                            </div>
                            <input type="checkbox" id="wifi-enabled" class="hidden" checked>
                        </div>
                        
                        <!-- WiFi Configuration (only shown when WiFi is enabled) -->
                        <div id="wifi-config" class="content-stretch flex flex-col gap-[16px] items-start relative shrink-0 w-full">
                            <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                                <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">WiFi Network</p>
                                <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                    <input type="text" id="wifi-ssid" placeholder="Enter WiFi network name" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                                </div>
                            </div>
                            
                            <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                                <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">WiFi Password</p>
                                <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                    <input type="password" id="wifi-password" placeholder="Enter WiFi password" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                                </div>
                    </div>
            </div>

                        <div id="error-2" class="error hidden"></div>
                        
                        <div class="content-stretch flex gap-[12px] items-center justify-between relative shrink-0 w-full">
                            <button id="back-btn-2" onclick="goToPreviousStep()" class="btn-outline content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 font-noto font-medium text-[14px]">
                                Back
                            </button>
                            <button id="next-btn-2" onclick="submitNetworkConfig()" class="btn-primary content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 text-white font-noto font-medium text-[14px]">
                                Next
                            </button>
                    </div>
                    </div>

                    <!-- Step 3: Owner Account Creation (only for new installation) -->
                    <div id="step-3" class="step hidden content-stretch flex flex-col gap-[32px] items-start relative shrink-0 w-full">
                        <div class="content-stretch flex flex-col gap-[4px] items-start leading-[normal] relative shrink-0 w-[278px] whitespace-pre-wrap">
                            <p class="font-noto font-semibold relative shrink-0 text-[18px] text-black w-full">Create Owner Account</p>
                            <p class="font-noto font-normal relative shrink-0 text-[#8e8e9d] text-[12px] w-full">Set up the primary administrator account</p>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Username</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="text" id="owner-username" placeholder="Enter username" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                            </div>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Email (Optional)</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="email" id="owner-email" placeholder="Enter email address (optional)" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                    </div>
                    </div>
                    
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Password</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="password" id="owner-password" placeholder="Enter strong password" maxlength="72" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                            </div>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Confirm Password</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="password" id="owner-confirm-password" placeholder="Confirm password" maxlength="72" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                    </div>
            </div>

                        <div id="error-3" class="error hidden"></div>
                        
                        <div class="content-stretch flex gap-[12px] items-center justify-between relative shrink-0 w-full">
                            <button id="back-btn-3" onclick="goToPreviousStep()" class="btn-outline content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 font-noto font-medium text-[14px]">
                                Back
                            </button>
                            <button id="next-btn-3" onclick="submitOwnerConfig()" class="btn-primary content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 text-white font-noto font-medium text-[14px]">
                                Next
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Device Information -->
                    <div id="step-4" class="step hidden content-stretch flex flex-col gap-[32px] items-start relative shrink-0 w-full">
                        <div class="content-stretch flex flex-col gap-[4px] items-start leading-[normal] relative shrink-0 w-[278px] whitespace-pre-wrap">
                            <p class="font-noto font-semibold relative shrink-0 text-[18px] text-black w-full">Device Information</p>
                            <p class="font-noto font-normal relative shrink-0 text-[#8e8e9d] text-[12px] w-full">Configure device settings and location</p>
                    </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Device Name</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="text" id="device-name" placeholder="Enter device name" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                    </div>
                    </div>
                    
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Location</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <input type="text" id="device-location" placeholder="Enter device location" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px]">
                            </div>
                        </div>
                        
                        <div class="content-stretch flex flex-col gap-[6px] items-start relative shrink-0 w-full">
                            <p class="font-noto font-medium leading-[normal] relative shrink-0 text-[14px] text-black w-full whitespace-pre-wrap">Description</p>
                            <div class="form-input content-stretch flex items-center justify-between px-[12px] py-[13px] relative rounded-[3px] shrink-0 w-full">
                                <textarea id="device-description" placeholder="Enter device description" rows="3" class="bg-transparent border-none outline-none w-full text-[#8c99a9] text-[14px] resize-none"></textarea>
                    </div>
            </div>

                        <div id="error-4" class="error hidden"></div>
                        
                        <div class="content-stretch flex gap-[12px] items-center justify-between relative shrink-0 w-full">
                            <button id="back-btn-4" onclick="goToPreviousStep()" class="btn-outline content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 font-noto font-medium text-[14px]">
                                Back
                            </button>
                            <button id="next-btn-4" onclick="submitDeviceConfig()" class="btn-primary content-stretch flex items-center justify-center px-[24px] py-[12px] relative rounded-[3px] shrink-0 text-white font-noto font-medium text-[14px]">
                                Complete Setup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let setupMode = 'new'; // 'new' or 'join'

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.add('hidden');
            });
            
            // Show current step
            document.getElementById(`step-${stepNumber}`).classList.remove('hidden');
            
            // Update step indicators
            for (let i = 1; i <= 4; i++) {
                const icon = document.getElementById(`step-icon-${i}`);
                const text = document.getElementById(`step-text-${i}`);
                
                if (i < stepNumber) {
                    icon.className = 'stepper-icon-completed box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]';
                    text.className = 'font-roboto font-normal leading-[1.3] relative shrink-0 text-[13px] stepper-text-inactive';
                } else if (i === stepNumber) {
                    icon.className = 'stepper-icon box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]';
                    text.className = 'font-roboto font-medium leading-[1.3] relative shrink-0 text-[13px] stepper-text-active';
            } else {
                    icon.className = 'stepper-icon-inactive box-border content-stretch flex flex-col gap-[10px] items-center justify-center p-[10px] relative rounded-[21px] shrink-0 size-[31px]';
                    text.className = 'font-roboto font-normal leading-[1.3] relative shrink-0 text-[13px] stepper-text-inactive';
                }
            }
        }

        function selectSetupMode(mode) {
            // Update radio button selection
            document.querySelectorAll('input[name="setup-mode"]').forEach(radio => {
                radio.checked = radio.value === mode;
            });
            
            // Update visual selection
            document.querySelectorAll('.bg-\\[\\#f9fafe\\]').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
            
            // Add selection indicator to selected card
            const selectedCard = document.querySelector(`input[value="${mode}"]`).closest('.bg-\\[\\#f9fafe\\]');
            selectedCard.classList.add('ring-2', 'ring-blue-500');
            
            setupMode = mode;
        }

        function proceedToNextStep() {
            // Get selected setup mode
            const selectedMode = document.querySelector('input[name="setup-mode"]:checked').value;
            setupMode = selectedMode;
            
            if (currentStep === 1) {
                currentStep = 2;
                showStep(currentStep);
            }
        }

        function toggleWiFi() {
            const wifiToggle = document.getElementById('wifi-toggle');
            const wifiEnabled = document.getElementById('wifi-enabled');
            const wifiConfig = document.getElementById('wifi-config');
            
            wifiEnabled.checked = !wifiEnabled.checked;
            
            if (wifiEnabled.checked) {
                wifiToggle.classList.add('active');
                wifiConfig.classList.remove('hidden');
            } else {
                wifiToggle.classList.remove('active');
                wifiConfig.classList.add('hidden');
                // Clear WiFi fields when disabled
                document.getElementById('wifi-ssid').value = '';
                document.getElementById('wifi-password').value = '';
            }
        }

        function goToPreviousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showError(stepNumber, message) {
            const errorDiv = document.getElementById(`error-${stepNumber}`);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function clearError(stepNumber) {
            const errorDiv = document.getElementById(`error-${stepNumber}`);
            if (errorDiv) {
            errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
        }
        
        async function submitNetworkConfig() {
            clearError(2);
            
            const networkMode = document.getElementById('network-mode').value;
            const wifiEnabled = document.getElementById('wifi-enabled').checked;
            const wifiSSID = document.getElementById('wifi-ssid').value;
            const wifiPassword = document.getElementById('wifi-password').value;
            
            // Only validate WiFi fields if WiFi is enabled
            if (wifiEnabled && (!wifiSSID || !wifiPassword)) {
                showError(2, 'Please fill in WiFi network name and password');
                return;
            }
            
            try {
                const payload = {
                    mode: networkMode,
                    wifi_enabled: wifiEnabled,
                    setup_mode: setupMode
                };
                
                // Only include WiFi credentials if WiFi is enabled
                if (wifiEnabled) {
                    payload.ssid = wifiSSID;
                    payload.wifi_password = wifiPassword;
                }
                
                const response = await fetch('/api/setup/network', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // Skip account creation if joining existing network
                    if (setupMode === 'join') {
                        currentStep = 4; // Skip to device info
                    } else {
                        currentStep = 3; // Go to account creation
                    }
                    showStep(currentStep);
                } else {
                    const error = await response.json();
                    showError(2, error.detail || 'Network configuration failed');
                }
            } catch (error) {
                showError(2, 'Network configuration failed: ' + error.message);
            }
        }
        
        async function submitOwnerConfig() {
            clearError(3);
            
            const username = document.getElementById('owner-username').value;
            const email = document.getElementById('owner-email').value;
            const password = document.getElementById('owner-password').value;
            const confirmPassword = document.getElementById('owner-confirm-password').value;
            
            if (!username || !password || !confirmPassword) {
                showError(3, 'Please fill in username and password fields');
                return;
            }
            
            if (password !== confirmPassword) {
                showError(3, 'Passwords do not match');
                return;
            }
            
            try {
            const payload = {
                    username: username,
                password: password,
                confirm_password: confirmPassword,
                    setup_mode: setupMode
                };
                
                // Only include email if it's provided
                if (email && email.trim() !== '') {
                    payload.email = email;
                }
                
                // Store owner data for later creation (don't create user yet)
                window.ownerData = {
                    username: username,
                    email: email,
                    password: password,
                    confirm_password: confirmPassword
                };
                
                // Move to next step without creating user
                currentStep = 4;
                showStep(currentStep);
            } catch (error) {
                showError(3, 'Account creation failed: ' + error.message);
            }
        }
        
        async function submitDeviceConfig() {
            clearError(4);
            
            const deviceName = document.getElementById('device-name').value;
            const deviceLocation = document.getElementById('device-location').value;
            const deviceDescription = document.getElementById('device-description').value;
            
            if (!deviceName || !deviceLocation) {
                showError(4, 'Please fill in device name and location');
                return;
            }
            
            try {
                // First create the owner account if we have owner data
                if (window.ownerData) {
                    const ownerPayload = {
                        username: window.ownerData.username,
                        password: window.ownerData.password,
                        confirm_password: window.ownerData.confirm_password,
                        setup_mode: setupMode
                    };
                    
                    // Only include email if it's provided
                    if (window.ownerData.email && window.ownerData.email.trim() !== '') {
                        ownerPayload.email = window.ownerData.email;
                    }
                    
                    const ownerResponse = await fetch('/api/auth/setup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(ownerPayload)
                    });
                    
                    if (!ownerResponse.ok) {
                        const error = await ownerResponse.json();
                        showError(4, error.detail || 'Owner account creation failed');
                        return;
                    }
                }
                
                // Then configure the device
                const payload = {
                    device_name: deviceName,
                    device_model: "CT3D-300", // Default model
                    group_name: "Default Group", // Default group
                    location: deviceLocation,
                    setup_mode: setupMode
                };
                
                const response = await fetch('/api/setup/device', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // Complete the setup process
                    try {
                        const completeResponse = await fetch('/api/setup/complete', {
                    method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ setup_mode: setupMode })
                        });
                        
                        if (completeResponse.ok) {
                            // Setup complete, redirect to login
                            window.location.href = '/login?message=Setup completed successfully';
                        } else {
                            const error = await completeResponse.json();
                            showError(4, error.detail || 'Setup completion failed');
                        }
                    } catch (error) {
                        showError(4, 'Setup completion failed: ' + error.message);
                    }
                } else {
                    const error = await response.json();
                    showError(4, error.detail || 'Device configuration failed');
                }
            } catch (error) {
                showError(4, 'Device configuration failed: ' + error.message);
            }
        }

        // Initialize
        showStep(1);
        
        // Initialize WiFi toggle
        document.addEventListener('DOMContentLoaded', function() {
            const wifiToggle = document.getElementById('wifi-toggle');
            const wifiEnabled = document.getElementById('wifi-enabled');
            
            if (wifiEnabled.checked) {
                wifiToggle.classList.add('active');
            }
        });
    </script>
</body>
</html>