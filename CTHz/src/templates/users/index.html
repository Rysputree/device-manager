{% extends "base.html" %}

{% block title %}User Management - CTHz Management System{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-info">
    <h1>User Management</h1>
    <p>Manage system users and their access permissions</p>
    </div>
    <button class="btn-add-user" onclick="showCreateUserModal()">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"/>
        </svg>
        ADD USER
        </button>
</div>

<!-- Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Total Users</span>
            <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
            </svg>
        </div>
        <div class="stat-value" id="totalUsers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Active Users</span>
            <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div class="stat-value" id="activeUsers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Administrators</span>
            <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div class="stat-value" id="adminUsers">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-header">
            <span class="stat-label">Monitors</span>
            <svg class="stat-icon" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div class="stat-value" id="monitorUsers">0</div>
    </div>
</div>

<!-- Users Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">All Users</h3>
        <p class="card-subtitle">Manage user accounts and permissions</p>
    </div>
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users-table-body">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Add New User</h3>
            <button class="modal-close" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <form id="add-user-form">
            <div class="form-group">
                <label class="form-label">Username *</label>
                <input type="text" class="form-input" name="username" required />
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email" />
            </div>
            <div class="form-group">
                <label class="form-label">Password *</label>
                <input type="password" class="form-input" name="password" maxlength="72" required />
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select class="form-select" name="role">
                    <option value="admin">Admin</option>
                    <option value="monitor">Monitor</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" name="first_name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" name="last_name" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit User</h3>
            <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
        </div>
        <form id="edit-user-form">
            <input type="hidden" name="user_id" id="edit-user-id" />
            <div class="form-group">
                <label class="form-label">Username *</label>
                <input type="text" class="form-input" name="username" id="edit-username" required />
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" name="email" id="edit-email" />
            </div>
            <div class="form-group">
                <label class="form-label">Role</label>
                <select class="form-select" name="role" id="edit-role">
                    <option value="admin">Admin</option>
                    <option value="monitor">Monitor</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" name="first_name" id="edit-first-name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" name="last_name" id="edit-last-name" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update User</button>
            </div>
        </form>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Reset Password</h3>
            <button class="modal-close" onclick="closeModal('resetPasswordModal')">&times;</button>
        </div>
        <form id="reset-password-form">
            <input type="hidden" name="user_id" id="reset-user-id" />
            <div class="form-group">
                <label class="form-label">New Password *</label>
                <input type="password" class="form-input" name="password" maxlength="72" required />
            </div>
            <div class="form-group">
                <label class="form-label">Confirm Password *</label>
                <input type="password" class="form-input" name="confirm_password" required />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Reset Password</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let users = [];

    // Load users on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    // Load users from API
    async function loadUsers() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/api/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                users = await response.json();
                renderUsers();
                updateStats();
            } else {
                showError('Failed to load users');
            }
        } catch (error) {
            showError('Failed to load users: ' + error.message);
        }
    }

    // Render users in table
    function renderUsers() {
        const tbody = document.getElementById('users-table-body');
        tbody.innerHTML = '';

        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-name">${user.username}</div>
                        <div class="user-email">${user.email || 'No email'}</div>
                    </div>
                </td>
                <td>
                    <span class="role-badge role-${user.role}">${user.role}</span>
                </td>
                <td>
                    <span class="status-badge status-active">Active</span>
                </td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                <td>
                    <div class="actions">
                        <button class="icon-btn icon-btn-edit" onclick="editUser(${user.id})" title="Edit">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                            </svg>
                        </button>
                        <button class="icon-btn icon-btn-edit" onclick="showResetPasswordModal(${user.id})" title="Reset Password">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        ${user.role !== 'owner' ? `
                        <button class="icon-btn icon-btn-delete" onclick="deleteUser(${user.id})" title="Delete">
                            <svg fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"/>
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                        ` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    // Update stats
    function updateStats() {
        const totalUsers = users.length;
        const activeUsers = users.filter(u => u.is_active !== false).length;
        const adminUsers = users.filter(u => u.role === 'admin').length;
        const monitorUsers = users.filter(u => u.role === 'monitor').length;

        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('activeUsers').textContent = activeUsers;
        document.getElementById('adminUsers').textContent = adminUsers;
        document.getElementById('monitorUsers').textContent = monitorUsers;
    }

    // Show create user modal
    function showCreateUserModal() {
        document.getElementById('addUserModal').style.display = 'block';
    }

    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // Edit user
    function editUser(userId) {
        const user = users.find(u => u.id === userId);
        if (user) {
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-role').value = user.role;
            document.getElementById('edit-first-name').value = user.first_name || '';
            document.getElementById('edit-last-name').value = user.last_name || '';
            document.getElementById('editUserModal').style.display = 'block';
        }
    }

    // Show reset password modal
    function showResetPasswordModal(userId) {
        document.getElementById('reset-user-id').value = userId;
        document.getElementById('resetPasswordModal').style.display = 'block';
    }

    // Save user (create or update)
    async function saveUser(userData, isEdit = false) {
        try {
            const token = localStorage.getItem('access_token');
            const url = isEdit ? `/api/users/${userData.user_id}` : '/api/users/';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            if (response.ok) {
                showSuccess(isEdit ? 'User updated successfully' : 'User created successfully');
                closeModal(isEdit ? 'editUserModal' : 'addUserModal');
                loadUsers();
            } else {
                const error = await response.json();
                showError(error.detail || 'Failed to save user');
            }
        } catch (error) {
            showError('Failed to save user: ' + error.message);
        }
    }

    // Reset password
    async function resetPassword(userId, password) {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/api/users/${userId}/reset-password`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password })
            });

            if (response.ok) {
                showSuccess('Password reset successfully');
                closeModal('resetPasswordModal');
            } else {
                const error = await response.json();
                showError(error.detail || 'Failed to reset password');
            }
        } catch (error) {
            showError('Failed to reset password: ' + error.message);
        }
    }

    // Delete user
    async function deleteUser(userId) {
        if (confirm('Are you sure you want to delete this user?')) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showSuccess('User deleted successfully');
                    loadUsers();
                } else {
                    const error = await response.json();
                    showError(error.detail || 'Failed to delete user');
                }
            } catch (error) {
                showError('Failed to delete user: ' + error.message);
            }
        }
    }

    // Form event listeners
    document.getElementById('add-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userData = Object.fromEntries(formData.entries());
        saveUser(userData, false);
    });

    document.getElementById('edit-user-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const userData = Object.fromEntries(formData.entries());
        saveUser(userData, true);
    });

    document.getElementById('reset-password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const password = formData.get('password');
        const confirmPassword = formData.get('confirm_password');
        const userId = formData.get('user_id');

        if (password !== confirmPassword) {
            showError('Passwords do not match');
            return;
        }

        resetPassword(userId, password);
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}